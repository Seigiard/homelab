services:
  pricebuddy:
    image: jez500/pricebuddy:latest
    container_name: pricebuddy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    depends_on:
      pricebuddy-db:
        condition: service_healthy
    environment:
      - TZ=${TZ:-Europe/Bratislava}
      - APP_URL=https://prices.${EXTERNAL_DOMAIN:-1218217.xyz}
      - ASSET_URL=https://prices.${EXTERNAL_DOMAIN:-1218217.xyz}
      - DB_HOST=pricebuddy-db
      - DB_DATABASE=pricebuddy
      - DB_USERNAME=pricebuddy
      - DB_PASSWORD=pricebuddy
      - SCRAPER_URL=http://pricebuddy-scraper:3000
    volumes:
      - pricebuddy-storage:/app/storage
    networks:
      - traefik-net
    labels:
      # Traefik - HTTP (local)
      - traefik.enable=true
      - traefik.http.routers.pricebuddy.rule=Host(`prices.${LOCAL_DOMAIN:-home.local}`)
      - traefik.http.routers.pricebuddy.entrypoints=web
      - traefik.http.services.pricebuddy.loadbalancer.server.port=80
      # Traefik - HTTPS (local via split-DNS)
      - traefik.http.routers.pricebuddy-secure.rule=Host(`prices.${EXTERNAL_DOMAIN:-1218217.xyz}`)
      - traefik.http.routers.pricebuddy-secure.entrypoints=websecure
      - traefik.http.routers.pricebuddy-secure.tls=true
      - traefik.http.routers.pricebuddy-secure.tls.certresolver=cloudflare
      - traefik.http.routers.pricebuddy-secure.middlewares=authelia@docker
      - traefik.http.routers.pricebuddy-secure.service=pricebuddy
      # Homepage
      - homepage.group=Tools
      - homepage.name=PriceBuddy
      - homepage.icon=mdi-tag-outline
      - homepage.href=https://prices.${EXTERNAL_DOMAIN:-1218217.xyz}
      - homepage.description=Price Tracker

  pricebuddy-db:
    image: mysql:8.2
    container_name: pricebuddy-db
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    command: --skip-log-bin
    environment:
      - MYSQL_ROOT_PASSWORD=pricebuddy
      - MYSQL_DATABASE=pricebuddy
      - MYSQL_USER=pricebuddy
      - MYSQL_PASSWORD=pricebuddy
    volumes:
      - ${APPDATA_PATH:-/opt/homelab/appdata}/pricebuddy/db:/var/lib/mysql
    networks:
      - traefik-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  pricebuddy-scraper:
    image: jez500/seleniumbase-scrapper:latest
    container_name: pricebuddy-scraper
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
    networks:
      - traefik-net

volumes:
  pricebuddy-storage:

networks:
  traefik-net:
    external: true
