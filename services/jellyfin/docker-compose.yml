services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    user: ${PUID:-1000}:${PGID:-1000}
    group_add:
      - "${RENDER_GROUP_ID:-104}"
    environment:
      - TZ=${TZ:-Europe/Bratislava}
      - JELLYFIN_PublishedServerUrl=https://movies.${EXTERNAL_DOMAIN:-1218217.xyz}
    volumes:
      # Config & cache (SSD)
      - ${APPDATA_PATH:-/opt/homelab/appdata}/jellyfin/config:/config
      - ${APPDATA_PATH:-/opt/homelab/appdata}/jellyfin/cache:/cache
      # Media (HDD) - mount entire public folder, configure libraries in UI
      - ${DATA_PATH:-/mnt/data}/public:/media
    devices:
      # Intel QuickSync / VAAPI
      - /dev/dri/renderD128:/dev/dri/renderD128
      - /dev/dri/card0:/dev/dri/card0
    deploy:
      resources:
        limits:
          cpus: '3.00'
          memory: 2G
    networks:
      - traefik-net
    labels:
      # Traefik - HTTP (local)
      - traefik.enable=true
      - traefik.http.routers.jellyfin.rule=Host(`movies.${LOCAL_DOMAIN:-home.local}`)
      - traefik.http.routers.jellyfin.entrypoints=web
      - traefik.http.services.jellyfin.loadbalancer.server.port=8096
      # Traefik - HTTPS (local via split-DNS)
      - traefik.http.routers.jellyfin-secure.rule=Host(`movies.${EXTERNAL_DOMAIN:-1218217.xyz}`)
      - traefik.http.routers.jellyfin-secure.entrypoints=websecure
      - traefik.http.routers.jellyfin-secure.tls=true
      - traefik.http.routers.jellyfin-secure.tls.certresolver=cloudflare
      - traefik.http.routers.jellyfin-secure.middlewares=authelia@docker
      - traefik.http.routers.jellyfin-secure.service=jellyfin
      # Homepage
      - homepage.group=Media
      - homepage.name=Jellyfin
      - homepage.icon=jellyfin
      - homepage.href=https://movies.${EXTERNAL_DOMAIN:-1218217.xyz}
      - homepage.description=Media streaming server

networks:
  traefik-net:
    external: true
